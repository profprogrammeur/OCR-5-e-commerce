<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>CART</title>
  </head>
  <body>
    <h1 id="para">CART</h1>
    <p id="result"></p>
    <!-- <p id="result"></p> -->

    <form method="post" action="">
      <p>
        <label for="firstName">Prénom :</label>
        <input
          type="text"
          required
          name="firstName"
          id="firstName"
          maxlength="20"
        />

        <br />
        <label for="lastName">Nom :</label>
        <input
          type="text"
          required
          name="lastName"
          id="lastName"
          maxlength="40"
        />

        <br />
        <label for="address">Adresse :</label>
        <input
          type="text"
          required
          name="address"
          id="address"
          maxlength="50"
        />

        <br />
        <label for="city">Ville :</label>
        <input type="text" required name="city" id="city" maxlength="40" />
        <br />
        <label for="email">Email :</label>
        <input type="email" name="email" id="email" maxlength="40" />
        <input type="submit" value="Submit" />
      </p>
    </form>

    <img id="pics" />
    <div id="totalDiv">TOTAL :</div>

    <ul id="ul"></ul>

    <!-- <ul id="ul"></ul> -->
    <input id="submit" type="submit" value="Submit" />
  </body>
  <script>
    ////get nproduct number from URL
    let url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    const _id = params.get("_id");
    let option = params.get("option");
    const h2num = document.getElementById("h2num");
    let count = -1;
    const para = document.getElementById("para");
    const totalDiv = document.getElementById("totalDiv");
    let totalPrice = 0;
    const ul = document.getElementById("ul");
    var response = "";
    const pics = document.getElementById("pics");
    let cart = JSON.parse(localStorage.getItem("cart"));
    var data;
    const firstName = document.getElementById("firstName");
    const lastName = document.getElementById("lastName");
    const adress = document.getElementById("adress");
    const city = document.getElementById("city");
    const email = document.getElementById("email");

    const result = document.getElementById("result");
    result.style.color = "red";
    requests = new Array(cart.length);

    // function loop () {
    const loop = () => {
      for (let i = 0; i < cart.length; i++) {
        var url2 = "http://localhost:3000/api/cameras/" + cart[i]._id;
        requests[i] = new XMLHttpRequest();
        requests[i].open("GET", url2);
        requests[i].onload = function() {
          data = JSON.parse(requests[i].responseText);
          console.log(data);
          count = i;
          option = cart[i].option;
          createListElements(data);
          totalPrice += data.price;
          console.log(totalPrice);
          totalDiv.textContent = "TOTAL = " + totalPrice + " €";
        };
        requests[i].send();
      }
    };
    loop();

    //////////////////
    //////////////////////////////////////////
    ////////////////////////////////
    function send() {
      var contact = {
        firstName: document.getElementById("firstName").value,
        lastName: document.getElementById("lastName").value,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        email: document.getElementById("email").value
      };

      var products = ["5be9c4c71c9d440000a730e9", "5be1ed3f1c9d44000030b061"];
      var body = { contact, products };
      var request = new XMLHttpRequest();
      // request.onreadystatechange = function() {
      //   if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
      //     var response = JSON.parse(this.responseText);
      //     // result.innerHTML = response.postData.text;
      //               result.innerHTML = response.postData.text;

      // console.log("response : " + response);
      //   }
      // };
      console.log(body);
      request.open("POST", "http://localhost:3000/api/cameras/order");
      // request.open("GET", "http://localhost:3000/api/cameras/order");

      request.setRequestHeader("Content-Type", "application/json");
      request.send(JSON.stringify(body));
      request.onreadystatechange = function() {
        // if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {

        // var response2 = request.response;
        console.log("response : " + request.response);
        result.textContent =
          "orderId : " + JSON.parse(request.response).orderId;
        result.style.color = "green";
      };
    }
    // }
    ////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////

    function createListElements(el) {
      createListElement(el.name);
      createListElement(el.lenses[option]);
      createListElement(el.price + " €");
      createListElement("request n° : " + count);
      createListElement("-----------------");
    }

    function createListElement(el) {
      var li = document.createElement("li"); // creates an element "li"
      li.appendChild(document.createTextNode(el)); //makes text from input field the li text
      ul.appendChild(li);
    }
    // totalDiv.textContent = "TOTAL = " + totalPrice + " €";
    ////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////
    const form = document.querySelector("form");
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      send();
    });

    // const regexName = /^[a-zA-Z_-]{3,16}$/;
    const regexName = /^[\w'\-,.][^0-9_!¡?÷?¿/\\+=@#$%ˆ&*(){}|~<>;:[\]]{2,}$/;
    const regexAddress = /^[\w'\-,.][^_!¡?÷?¿/\\+=@#$%ˆ&*(){}|~<>;:[\]]{2,}$/;

    // /^[a-zA-Z0-9_-]{3,16}$/
    // firstName.addEventListener("change", function() {
    function fieldValidation(field, regex) {
      console.log("field : " + field.name);
      field.addEventListener("change", function() {
        console.log("field : " + field.name);
        if (regex.test(field.value)) {
          result.textContent = "";
          field.style.color = "black";
        } else {
          result.textContent = "Donnée invalide";
          field.style.color = "red";
        }
      });
    }

    ////JUSTE PREMIER MARCHE

    fieldValidation(firstName, regexName);
    fieldValidation(lastName, regexName);
    fieldValidation(city, regexName);
    fieldValidation(address, regexAddress);
    fieldValidation(email, regexAddress);

    //   if (regexName.test(firstName.value)) {
    //     result.textContent = "";
    //     firstName.style.color = "black";
    //   } else {
    //     result.textContent = "Donnée invalide";
    //     firstName.style.color="red";
    //   }
    // });

    // lastName.addEventListener("change", function() {
    //   if (regexName.test(lastName.value)) {
    //     result.textContent = "";
    //   } else {
    //     result.textContent = "Nom invalide";
    //   }
    // });

    // adress.addEventListener("change", function() {
    //   if (regexAdress.test(adress.value)) {
    //     result.textContent = "";
    //   } else {
    //     result.textContent = "Adresse invalide";
    //   }
    // });
  </script>
</html>
